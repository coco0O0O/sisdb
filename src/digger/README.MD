### 一、 策略算法平台介绍  

    1.1. 安装部署  
    依赖于stsdb;  

    1.2. 运行调用接口

    127.0.0.1：6379 > digger.start [name] [command]  
            
            功能说明：
                启动一个策略服务

            参数说明：  
                [name] -- 为策略名称    
                [command] -- 为json格式的策略配置  

            返回数据为： 
                [name]000012  # 返回当前运行算法的唯一编号
                每次运行一个算法都是新的计算单元，这样做的原因是command可能不同，  


    127.0.0.1：6379 > digger.get xxxx000012.status 
            
            功能说明:   
                status -- 获取当前策略运行的状态  
                config -- 获取当前策略运行的配置
                money  -- 不带参数--最新的资金情况  
                          带参数--历史资金变动(需要增加开始和结束日期，若没有就返回全部)
                stock  -- 不带参数--当前持股  带参数 -- 历史持股信息
                trade  -- 不带参数--交易明细  带参数 -- 历史交易信息

    127.0.0.1：6379 > digger.stop xxxx000012 
            功能说明：
                停止一个策略服务

    127.0.0.1：6379 > digger.load xxxx000012 
            功能说明：
                重新启动一个策略服务

    127.0.0.1：6379 > digger.sub xxxx000012  
            功能说明：订阅当前算法的交易指令  

    127.0.0.1：6379 > digger.pub xxxx000012 [command]
            功能说明：发布一个交易指令，用于人工策略交易
            参数说明：[command] -- 为json格式的交易指令  
            
            ** 暂时存在,未来没用 **

    127.0.0.1：6379 > digger.set xxxx000012 [command]
            功能说明：需要对持仓和资金量进行调整时使用，然后交由算法来判定交易指令
            参数说明：[command] -- 为json格式的持仓指令  
            特别注意：
                增加股票按当前的股价，当前时间，不然总市值会不确定，影响算法的计算，股票增加会影响总资产变化；
                使用此命令输入的股票必须做好标记，以方便统计时不计入收益计算中

            ** 出现特殊异常情况,小概率使用 **

    1.3. 调试调用接口

    127.0.0.1：6379 > digger.start [name] [command]  
            
            功能说明：
                启动一个策略服务

            参数说明：  
                [name] -- 为策略名称    
                [command] -- 为json格式的策略配置  

            返回数据为： 
                [name]000012  # 返回当前运行算法的唯一编号
                每次运行一个算法都是新的计算单元，这样做的原因是command可能不同，  


    127.0.0.1：6379 > digger.get xxxx000012.status 
            
            功能说明:   
                status -- 获取当前策略运行的状态  
                config -- 获取当前策略运行的配置
                lists  -- 获取参数调整算法的结果列表，包括每种算法的收益率，成功率等信息，
                money  -- 不带参数--最新的资金情况  
                          带参数--历史资金变动(需要增加开始和结束日期，若没有就返回全部)
                stock  -- 不带参数--当前持股  带参数 -- 历史持股信息
                trade  -- 不带参数--交易明细  带参数 -- 历史交易信息

    127.0.0.1：6379 > digger.stop xxxx000012 
            功能说明：
                停止一个策略服务


### 二、 策略算法(运行期)配置文件详解  

服务端会首先加载 name.conf 为名的配置文件，并根据command中的信息，对原配置文件进行修改，(修改级别为叶端)

[command] -- 仅仅存放个性的指令

conf 的配置文件

release : {
    codes : * ,  # 准备买入的股票 * 为所有A股 待买股票可以是 "SH600600,SH600601" 中间以逗号分隔
    classify :   # 对codes股票进行分类, 分类后会在每个code返回一个 classname，再去class中匹配该类的策略
    {
        methods :  [  # 分类方法 没有权重，按顺序执行，会携带上一个方法的分类结果,后面的会冲洗掉前面的
           { name: filter, argv:{} },  # 默认仅仅有一个方法 分 active surprise stable danger 四种类型
           { name: exclude, argv:{ codes: "SZ002100,SZ002101", names: "st"} }
        ]
    },
    # ---------------------------------------------------------------#
    # 对于以上分类策略           
    # 返回值为 danger - 表示只卖不买， 其他字符串到class中匹配
    # 返回值格式为: { sh600600:{ classify:active },
    #               sh600601:{ classify:active },
    #               ... 
    #               sz003002:{ classify:danger }}
    # ---------------------------------------------------------------#

    algorithms : {
        active : # 活跃蓝筹股 最近三年振幅相对较大的 业绩不错 成交量大的
        {
            buy-methods: [ # 这里放买入股票的策略算法，
                { name: select_buy, argv:{} weight: 100 }, # 算法返回数据为 2 项值 0 表示观望 1 表示买入 2
                { name: select_buy, argv:{} weight: 100 }, # 算法返回数据为 4 项值 4 个状态
                { name: select_buy, argv:{} weight: 100 }  # 算法返回数据为 64 项值 64个状态
            ],
            sell-methods: [ # 这里放选股的策略算法，
                { name: select_sell, argv:{} weight: 100 }, # 算法返回数据为 2项值 0 表示观望 1 表示卖出 2
                { name: select_sell, argv:{} weight: 100 },
                { name: select_sell, argv:{} weight: 100 }
            ]
            # 按权重得到的取值范围在 0..255 之间
            # 买卖分开 是因为实际运行中买卖的codes码表不同，避免重复计算
            #         买入和卖出的规则可能不同
            # 卖出减去买入的值 大于 0 就进入买入序列，小于 0 表示卖出序列， 等于 0 观望
        },
        # surprise : # 活跃黑马股 最近三年振幅相对较大的 无关业绩 无关成交量
        # stable : # 稳定的股票 最近三年振幅小，相对平稳的，比如银行股
    },
    # ---------------------------------------------------------------#
    # 对于以上交易策略
    # 可以单独考核发出买入信号和卖出信号后交易的盈利概率，超过50%才为合格的交易策略，否则直接转入下一个参数
    # 返回值格式为: { sh600600:{ classify:active, algorithms:{ select_buy: 1} },
    #               sh600601:{ classify:active, algorithms:{ select_buy: 1} },
    #               ... 
    #               sz003002:{ classify:danger }
    # ---------------------------------------------------------------#

    risk:  # 风控 主要针对已经持仓或即将买入的股票，也是买入指令前最后一道关口
    {
        stock-methods : # 针对单只股票的风控策略
        [  
            { name: stopless, argv: { rate: 0.062 } },   # 止损幅度，超过该跌幅立即止损，忽略买入信号，卖出    
            { name: sideway, argv: { days: 60, rate: 0.03 } }  # 横盘天数，一直横盘一定幅度，忽略买入信号，卖出 
            # 对于是针对单只股票的交易策略
        ],
        # ---------------------------------------------------------------#
        # 对于stock-methods风控策略，主要用于把符合条件的股票放入卖出队列，
        # ---------------------------------------------------------------#
        money-methods : # 针对整体的资金风控策略
        [
            # { name: stockindex, argv: { code:sh000001, days: 5, reduce: 0.3 } }  
            # 股票指数连续市值下跌天数, 连续下跌5天 触发减仓事件
            # reduce 触发减仓事件时，减仓的资金比例
            { name: ownerindex, argv: { days: 5, reduce: 0.3 } } 
            # 通过该策略进行交易的组合连续市值下跌天数, 连续下跌5天 触发减仓事件
        ]
        # ---------------------------------------------------------------#
        # 对于money-methods风控策略，主要用于持仓资金的比列
        # ---------------------------------------------------------------#
    },
    # ---------------------------------------------------------------#
    # 通过以上的策略，下面进入实际下单的资金配比策略
    # 到此时，会得到一个买入股票列表，卖出股票列表，可以动用的资金比例
    # ---------------------------------------------------------------#
    money :  # 资金管理 需要对所有股票列表进行排序，然后根据最后股票的唯一返回值为顺序，先下卖单，再下买单
    {
        all : 1000000, # 操作资金
        min : 50000,   # 单笔最小交易资金
        max : 100000,  # 单只股票最大资金
        methods : [    # 这里放股票优劣性的算法 返回一个相对的数值，再根据权重分配资金
            { name: hold, argv:{}, weight:30 },    # 持仓的加分策略，避免频繁操作
            { name: energy, argv:{}, weight:70 }   # 按能量算法
        ]
        # 可采用多种方法来排序，每种排序方法乘以权重再相加，为排序最后的标准
    }
}

    -- 算法返回值全部进行抽象化，以方便统计和合并，根据以下值来做统一数据评判
       一个字节表示 2，4，8，64种状态
       00 : 2 -- 01 : 4 -- 10 : 8 -- 11 : 64
       2 表示布尔型，仅仅是做一个判断，比如是否st，是否国资控股等
       4 只有3个有效值，买入1 卖出2 观望0
       8 7个有效值 买入3种程度 卖出3种程度 观望
       64 当不确定买入还是卖出，仅仅对股票进行评估其上涨下跌概率时，用这个来描述其程度

       每个算法根据自己数据的特性返回以上4中格式数据，最后都会被转换为255*权重的数值，然后相加；
       相当于对所有的干扰项进行虚拟数据标准化
       权重的计算可以参考贝叶斯算法，利用机器学习来完善--- 后期完善

    -- 先根据风控后的卖出和减仓信号，合并买入信号，生成 卖出 减仓的指令， 然后再
       从头开始，发出 买入，增持，观望(具备买入条件，但超出最大资金量)的指令

### 三、 策略算法(调试期)配置文件详解 

debug : {
    start: 20160101, --  开始调试时间
    stop : 20170707,  --  结束调试时间
    # **** 下面参阅 release **** #
    # 以 sell-methods 为例 当方法的argv 和 weight 为数组时，表示要求分解运算，以求出最大收益率
    # [最小值，最大值，步长]
    # 多个方法权重以第一个为准，依次递推出最优权重
    #        sell-methods: [ # 这里放选股的策略算法，
    #            { name: select_sell, argv:{ level: [0,3,1]} weight: [0,100,5] },
    #            { name: select_sell, argv:{} weight: [0,100,5] },
    #            { name: select_sell, argv:{} weight: [0,100,5] }
    #        ]
}

### 四、 策略算法函数集

    digger.method [name] [input] [avgv]

    返回值: [output]  -- 该返回值会作为下一个方法的入口值进行传递，因此格式必须通用

### 五、 策略算法分布运算详解  

    * 未来运算量巨大时实现